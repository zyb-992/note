# 事务

1. 事务的四个特性

   - **原子性**: 一个事务中的所有操作在一个执行过程中必须被全部执行完毕 若发生错误 就把已经执行的操作回滚成没执行之前的模样
   - **隔离性**: 保证事务中的操作以原子性的方式执行完成之外 还需要保证其他事务的状态转换不会影响到本次状态转换
   - **持久性**: 当状态转换完成后 这个转换的结果将永久保留（对于Mysql保留到磁盘中 无论此后发生什么事故 本次转换造成的结果都保留到了磁盘中 重新启动Mysql服务将会恢复原样）
   - **一致性**: 符合现实世界的约束 例如对某列建立唯一索引 若插入某条记录时发现该列的值重复了 Mysql就会报错并且拒绝插入 （CHECK语句

2. 事务的状态

   - 活动的
   - 部分提交的
   - 失败的
   - 中止的
   - 提交的

3. 开启事务

   ```mysql
   BEGIN;
   START TRANSACTION;
   ```

   - START TRANSACTION 可以跟随修饰符来设置事务的访问模式
     - READ ONLY
     - READ WRITE
     - WITH CONSISTENT SNAPSHOT ：启动一致性读

4. 提交事务

   ```mysql
   COMMIT;
   ```

5. 手动中止事务

   ```mysql
   ROLLBACK;
   ```

   - `ROLLBACK`是手动回滚事务时使用的 如果事务在执行过程中遇到了某些错误无法继续执行 大部分情况下会回滚失败的语句 在某些情况下会回滚整个事务

6. 当前支持事务的存储引擎

   1. InnoDB
   2. NDB

7. **自动提交**

   1. Mysql中有一个系统变量autocommit 用来自动提交事务

      ```mysql
      SHOW VARIABLES LIKE 'autocommit';
      
      # autocommit为OFF时，每条命令执行完都需要执行一次commit语句进行事务提交
      ```
      
      - 其默认值为ON 表示不显示开启事务的时候 每条语句都算是一个独立的事务 称为**事务的自动提交**

8. **保存点**

   1. 在事务对应的数据库语句中保存某些点 使得某些语句执行出错时回滚事务的时候不必全部回滚

   ```mysql
   SAVEPOINT 保存点名称;
   
   ROLLBACK 保存点名称;
   
   # 删除保存点
   RELEASE SAVEPOINT 保存点名称;
   ```

   

# 事务隔离级别

1. 如果并发执行的多个事务会访问数据库中相同的数据 就可能导致不能满足某些一致性需求 这就需要我们使用某种手段来强制让这些事务一个个按照顺序单独执行 或者最终执行的效果和单独执行一样 也就是**让这些事务”隔离"地执行** 互不干涉

2. 对于串行执行来说 系统的同一时刻最多只能允许一个事务执行 那么这保证了隔离的要求以及结果 但是串行执行的效率相比并发慢很多 严重降低系统吞吐量以及资源利用率 将会增加事务的等待时间

3. 因此我们设立 **当某个事务访问某个数据时 对要求其他试图访问相同的数据的事务进行限制 让它们进行排队 当该事务提交之后 其他事务才能继续访问这个数据 这样可以让并发执行的事务的执行结果与串行执行的结果一致** 这种方式称为**可串行化执行**

4. 两个并发的事务在执行过程中访问相同数据的情况

   - 读-读
   - 读-写
   - 写-读
   - 写-写

   **只有在至少一个事务对数据进行写操作时 才可能带来数据库的一致性问题**

   

## 事务并发执行遇到的一致性问题

1. 脏写(Dirty Write)
   - 一个事务修改了另一个未提交事务修改过的数据 即脏写
2. 脏读
   - 一个事务读取到了另一个**未提交**事务修改过的数据
3. 幻读
   - 如果一个事务先根据某些搜索条件查询出一些记录 在该事务未提交时 另一个事务写入了一些符合那些搜索条件的记录（写入指：插入删除修改等操作）就意味着发生幻读现象
   - 对于Mysql来说 幻读强调的是一个事务在按照某个相同的搜索条件多次读取记录时 在后读取时读到了之前没有读到的记录
4. 不可重复读(模糊读)
   - 在一个事务内多次读取同一个数据，如果出现前后两次读到的数据不一样的情况，就意味着发生了「不可重复读」现象。

## SQL标准中的4种隔离级别

1. 对于导致不一致性问题的严重性：**脏写>脏读>不可重复>幻读**

### 4种隔离级别

- **READ UNCOMMITED ：未提交读**
- **READ COMMITED ： 已提交读**
- **REPEATABLE READ ：可重复读**
- **SERIALIZABLE ：可串行化**

![image-20220901164356974](https://raw.githubusercontent.com/zyb-992/Photobed/master/zyb/202209111655788.png)

- 脏写现象对一致性问题印象太严重 无论哪种隔离级别 都不允许脏写的情况发生	

2. 设置事务的隔离级别

   ```mysql
   SET GLOBAL|SESSION TRANSACTION ISOLATION LEVEL level;
   ```

3. 确定当前会话默认的隔离级别

   ```mysql
   show variables like 'transaction_isolation';
   ```

![image-20220901170722695](https://raw.githubusercontent.com/zyb-992/Photobed/master/zyb/202209111655789.png)



# MVCC原理

1. 